{"ast":null,"code":"/* Copyright 2016 Yury Karpovich\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/*\n MSG Reader\n */\n(function (root, factory) {\n  if (typeof define === 'function' && define.amd) {\n    // AMD\n    define(['./DataStream'], factory);\n  } else if (typeof exports === 'object') {\n    // Node, CommonJS-like\n    module.exports = factory(require('./DataStream'));\n  } else {\n    // Browser globals (root is window)\n    root.MSGReader = factory(root.DataStream);\n  }\n})(this, function (DataStream) {\n  // constants\n  var CONST = {\n    FILE_HEADER: uInt2int([0xD0, 0xCF, 0x11, 0xE0, 0xA1, 0xB1, 0x1A, 0xE1]),\n    MSG: {\n      UNUSED_BLOCK: -1,\n      END_OF_CHAIN: -2,\n      S_BIG_BLOCK_SIZE: 0x0200,\n      S_BIG_BLOCK_MARK: 9,\n      L_BIG_BLOCK_SIZE: 0x1000,\n      L_BIG_BLOCK_MARK: 12,\n      SMALL_BLOCK_SIZE: 0x0040,\n      BIG_BLOCK_MIN_DOC_SIZE: 0x1000,\n      HEADER: {\n        PROPERTY_START_OFFSET: 0x30,\n        BAT_START_OFFSET: 0x4c,\n        BAT_COUNT_OFFSET: 0x2C,\n        SBAT_START_OFFSET: 0x3C,\n        SBAT_COUNT_OFFSET: 0x40,\n        XBAT_START_OFFSET: 0x44,\n        XBAT_COUNT_OFFSET: 0x48\n      },\n      PROP: {\n        NO_INDEX: -1,\n        PROPERTY_SIZE: 0x0080,\n        NAME_SIZE_OFFSET: 0x40,\n        MAX_NAME_LENGTH:\n        /*NAME_SIZE_OFFSET*/\n        0x40 / 2 - 1,\n        TYPE_OFFSET: 0x42,\n        PREVIOUS_PROPERTY_OFFSET: 0x44,\n        NEXT_PROPERTY_OFFSET: 0x48,\n        CHILD_PROPERTY_OFFSET: 0x4C,\n        START_BLOCK_OFFSET: 0x74,\n        SIZE_OFFSET: 0x78,\n        TYPE_ENUM: {\n          DIRECTORY: 1,\n          DOCUMENT: 2,\n          ROOT: 5\n        }\n      },\n      FIELD: {\n        PREFIX: {\n          ATTACHMENT: '__attach_version1.0',\n          RECIPIENT: '__recip_version1.0',\n          DOCUMENT: '__substg1.'\n        },\n        // example (use fields as needed)\n        NAME_MAPPING: {\n          // email specific\n          '0037': 'subject',\n          '0c1a': 'senderName',\n          '5d02': 'senderEmail',\n          '1000': 'body',\n          '007d': 'headers',\n          // attachment specific\n          '3703': 'extension',\n          '3704': 'fileNameShort',\n          '3707': 'fileName',\n          '3712': 'pidContentId',\n          // recipient specific\n          '3001': 'name',\n          '39fe': 'email'\n        },\n        CLASS_MAPPING: {\n          ATTACHMENT_DATA: '3701'\n        },\n        TYPE_MAPPING: {\n          '001e': 'string',\n          '001f': 'unicode',\n          '0102': 'binary'\n        },\n        DIR_TYPE: {\n          INNER_MSG: '000d'\n        }\n      }\n    }\n  }; // unit utils\n\n  function arraysEqual(a, b) {\n    if (a === b) return true;\n    if (a == null || b == null) return false;\n    if (a.length != b.length) return false;\n\n    for (var i = 0; i < a.length; i++) {\n      if (a[i] !== b[i]) return false;\n    }\n\n    return true;\n  }\n\n  function uInt2int(data) {\n    var result = new Array(data.length);\n\n    for (var i = 0; i < data.length; i++) {\n      result[i] = data[i] << 24 >> 24;\n    }\n\n    return result;\n  } // MSG Reader implementation\n  // check MSG file header\n\n\n  function isMSGFile(ds) {\n    ds.seek(0);\n    return arraysEqual(CONST.FILE_HEADER, ds.readInt8Array(CONST.FILE_HEADER.length));\n  } // FAT utils\n\n\n  function getBlockOffsetAt(msgData, offset) {\n    return (offset + 1) * msgData.bigBlockSize;\n  }\n\n  function getBlockAt(ds, msgData, offset) {\n    var startOffset = getBlockOffsetAt(msgData, offset);\n    ds.seek(startOffset);\n    return ds.readInt32Array(msgData.bigBlockLength);\n  }\n\n  function getNextBlockInner(ds, msgData, offset, blockOffsetData) {\n    var currentBlock = Math.floor(offset / msgData.bigBlockLength);\n    var currentBlockIndex = offset % msgData.bigBlockLength;\n    var startBlockOffset = blockOffsetData[currentBlock];\n    return getBlockAt(ds, msgData, startBlockOffset)[currentBlockIndex];\n  }\n\n  function getNextBlock(ds, msgData, offset) {\n    return getNextBlockInner(ds, msgData, offset, msgData.batData);\n  }\n\n  function getNextBlockSmall(ds, msgData, offset) {\n    return getNextBlockInner(ds, msgData, offset, msgData.sbatData);\n  } // convert binary data to dictionary\n\n\n  function parseMsgData(ds) {\n    var msgData = headerData(ds);\n    msgData.batData = batData(ds, msgData);\n    msgData.sbatData = sbatData(ds, msgData);\n\n    if (msgData.xbatCount > 0) {\n      xbatData(ds, msgData);\n    }\n\n    msgData.propertyData = propertyData(ds, msgData);\n    msgData.fieldsData = fieldsData(ds, msgData);\n    return msgData;\n  } // extract header data\n\n\n  function headerData(ds) {\n    var headerData = {}; // system data\n\n    headerData.bigBlockSize = ds.readByte(\n    /*const position*/\n    30) == CONST.MSG.L_BIG_BLOCK_MARK ? CONST.MSG.L_BIG_BLOCK_SIZE : CONST.MSG.S_BIG_BLOCK_SIZE;\n    headerData.bigBlockLength = headerData.bigBlockSize / 4;\n    headerData.xBlockLength = headerData.bigBlockLength - 1; // header data\n\n    headerData.batCount = ds.readInt(CONST.MSG.HEADER.BAT_COUNT_OFFSET);\n    headerData.propertyStart = ds.readInt(CONST.MSG.HEADER.PROPERTY_START_OFFSET);\n    headerData.sbatStart = ds.readInt(CONST.MSG.HEADER.SBAT_START_OFFSET);\n    headerData.sbatCount = ds.readInt(CONST.MSG.HEADER.SBAT_COUNT_OFFSET);\n    headerData.xbatStart = ds.readInt(CONST.MSG.HEADER.XBAT_START_OFFSET);\n    headerData.xbatCount = ds.readInt(CONST.MSG.HEADER.XBAT_COUNT_OFFSET);\n    return headerData;\n  }\n\n  function batCountInHeader(msgData) {\n    var maxBatsInHeader = (CONST.MSG.S_BIG_BLOCK_SIZE - CONST.MSG.HEADER.BAT_START_OFFSET) / 4;\n    return Math.min(msgData.batCount, maxBatsInHeader);\n  }\n\n  function batData(ds, msgData) {\n    var result = new Array(batCountInHeader(msgData));\n    ds.seek(CONST.MSG.HEADER.BAT_START_OFFSET);\n\n    for (var i = 0; i < result.length; i++) {\n      result[i] = ds.readInt32();\n    }\n\n    return result;\n  }\n\n  function sbatData(ds, msgData) {\n    var result = [];\n    var startIndex = msgData.sbatStart;\n\n    for (var i = 0; i < msgData.sbatCount && startIndex != CONST.MSG.END_OF_CHAIN; i++) {\n      result.push(startIndex);\n      startIndex = getNextBlock(ds, msgData, startIndex);\n    }\n\n    return result;\n  }\n\n  function xbatData(ds, msgData) {\n    var batCount = batCountInHeader(msgData);\n    var batCountTotal = msgData.batCount;\n    var remainingBlocks = batCountTotal - batCount;\n    var nextBlockAt = msgData.xbatStart;\n\n    for (var i = 0; i < msgData.xbatCount; i++) {\n      var xBatBlock = getBlockAt(ds, msgData, nextBlockAt);\n      nextBlockAt = xBatBlock[msgData.xBlockLength];\n      var blocksToProcess = Math.min(remainingBlocks, msgData.xBlockLength);\n\n      for (var j = 0; j < blocksToProcess; j++) {\n        var blockStartAt = xBatBlock[j];\n\n        if (blockStartAt == CONST.MSG.UNUSED_BLOCK || blockStartAt == CONST.MSG.END_OF_CHAIN) {\n          break;\n        }\n\n        msgData.batData.push(blockStartAt);\n      }\n\n      remainingBlocks -= blocksToProcess;\n    }\n  } // extract property data and property hierarchy\n\n\n  function propertyData(ds, msgData) {\n    var props = [];\n    var currentOffset = msgData.propertyStart;\n\n    while (currentOffset != CONST.MSG.END_OF_CHAIN) {\n      convertBlockToProperties(ds, msgData, currentOffset, props);\n      currentOffset = getNextBlock(ds, msgData, currentOffset);\n    }\n\n    createPropertyHierarchy(props,\n    /*property with index 0 (zero) always as root*/\n    props[0]);\n    return props;\n  }\n\n  function convertName(ds, offset) {\n    var nameLength = ds.readShort(offset + CONST.MSG.PROP.NAME_SIZE_OFFSET);\n\n    if (nameLength < 1) {\n      return '';\n    } else {\n      return ds.readStringAt(offset, nameLength / 2);\n    }\n  }\n\n  function convertProperty(ds, index, offset) {\n    return {\n      index: index,\n      type: ds.readByte(offset + CONST.MSG.PROP.TYPE_OFFSET),\n      name: convertName(ds, offset),\n      // hierarchy\n      previousProperty: ds.readInt(offset + CONST.MSG.PROP.PREVIOUS_PROPERTY_OFFSET),\n      nextProperty: ds.readInt(offset + CONST.MSG.PROP.NEXT_PROPERTY_OFFSET),\n      childProperty: ds.readInt(offset + CONST.MSG.PROP.CHILD_PROPERTY_OFFSET),\n      // data offset\n      startBlock: ds.readInt(offset + CONST.MSG.PROP.START_BLOCK_OFFSET),\n      sizeBlock: ds.readInt(offset + CONST.MSG.PROP.SIZE_OFFSET)\n    };\n  }\n\n  function convertBlockToProperties(ds, msgData, propertyBlockOffset, props) {\n    var propertyCount = msgData.bigBlockSize / CONST.MSG.PROP.PROPERTY_SIZE;\n    var propertyOffset = getBlockOffsetAt(msgData, propertyBlockOffset);\n\n    for (var i = 0; i < propertyCount; i++) {\n      var propertyType = ds.readByte(propertyOffset + CONST.MSG.PROP.TYPE_OFFSET);\n\n      switch (propertyType) {\n        case CONST.MSG.PROP.TYPE_ENUM.ROOT:\n        case CONST.MSG.PROP.TYPE_ENUM.DIRECTORY:\n        case CONST.MSG.PROP.TYPE_ENUM.DOCUMENT:\n          props.push(convertProperty(ds, props.length, propertyOffset));\n          break;\n\n        default:\n          /* unknown property types */\n          props.push(null);\n      }\n\n      propertyOffset += CONST.MSG.PROP.PROPERTY_SIZE;\n    }\n  }\n\n  function createPropertyHierarchy(props, nodeProperty) {\n    if (nodeProperty.childProperty == CONST.MSG.PROP.NO_INDEX) {\n      return;\n    }\n\n    nodeProperty.children = [];\n    var children = [nodeProperty.childProperty];\n\n    while (children.length != 0) {\n      var currentIndex = children.shift();\n      var current = props[currentIndex];\n\n      if (current == null) {\n        continue;\n      }\n\n      nodeProperty.children.push(currentIndex);\n\n      if (current.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {\n        createPropertyHierarchy(props, current);\n      }\n\n      if (current.previousProperty != CONST.MSG.PROP.NO_INDEX) {\n        children.push(current.previousProperty);\n      }\n\n      if (current.nextProperty != CONST.MSG.PROP.NO_INDEX) {\n        children.push(current.nextProperty);\n      }\n    }\n  } // extract real fields\n\n\n  function fieldsData(ds, msgData) {\n    var fields = {\n      attachments: [],\n      recipients: []\n    };\n    fieldsDataDir(ds, msgData, msgData.propertyData[0], fields);\n    return fields;\n  }\n\n  function fieldsDataDir(ds, msgData, dirProperty, fields) {\n    if (dirProperty.children && dirProperty.children.length > 0) {\n      for (var i = 0; i < dirProperty.children.length; i++) {\n        var childProperty = msgData.propertyData[dirProperty.children[i]];\n\n        if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {\n          fieldsDataDirInner(ds, msgData, childProperty, fields);\n        } else if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DOCUMENT && childProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.DOCUMENT) == 0) {\n          fieldsDataDocument(ds, msgData, childProperty, fields);\n        }\n      }\n    }\n  }\n\n  function fieldsDataDirInner(ds, msgData, dirProperty, fields) {\n    if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.ATTACHMENT) == 0) {\n      // attachment\n      var attachmentField = {};\n      fields.attachments.push(attachmentField);\n      fieldsDataDir(ds, msgData, dirProperty, attachmentField);\n    } else if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.RECIPIENT) == 0) {\n      // recipient\n      var recipientField = {};\n      fields.recipients.push(recipientField);\n      fieldsDataDir(ds, msgData, dirProperty, recipientField);\n    } else {\n      // other dir\n      var childFieldType = getFieldType(dirProperty);\n\n      if (childFieldType != CONST.MSG.FIELD.DIR_TYPE.INNER_MSG) {\n        fieldsDataDir(ds, msgData, dirProperty, fields);\n      } else {\n        // MSG as attachment currently isn't supported\n        fields.innerMsgContent = true;\n      }\n    }\n  }\n\n  function fieldsDataDocument(ds, msgData, documentProperty, fields) {\n    var value = documentProperty.name.substring(12).toLowerCase();\n    var fieldClass = value.substring(0, 4);\n    var fieldType = value.substring(4, 8);\n    var fieldName = CONST.MSG.FIELD.NAME_MAPPING[fieldClass];\n\n    if (fieldName) {\n      fields[fieldName] = getFieldValue(ds, msgData, documentProperty, fieldType);\n    }\n\n    if (fieldClass == CONST.MSG.FIELD.CLASS_MAPPING.ATTACHMENT_DATA) {\n      // attachment specific info\n      fields['dataId'] = documentProperty.index;\n      fields['contentLength'] = documentProperty.sizeBlock;\n    }\n  }\n\n  function getFieldType(fieldProperty) {\n    var value = fieldProperty.name.substring(12).toLowerCase();\n    return value.substring(4, 8);\n  } // extractor structure to manage bat/sbat block types and different data types\n\n\n  var extractorFieldValue = {\n    sbat: {\n      'extractor': function extractDataViaSbat(ds, msgData, fieldProperty, dataTypeExtractor) {\n        var chain = getChainByBlockSmall(ds, msgData, fieldProperty);\n\n        if (chain.length == 1) {\n          return readDataByBlockSmall(ds, msgData, fieldProperty.startBlock, fieldProperty.sizeBlock, dataTypeExtractor);\n        } else if (chain.length > 1) {\n          return readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor);\n        }\n\n        return null;\n      },\n      dataType: {\n        'string': function extractBatString(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          return ds.readString(blockSize);\n        },\n        'unicode': function extractBatUnicode(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          return ds.readUCS2String(blockSize / 2);\n        },\n        'binary': function extractBatBinary(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          var toReadLength = Math.min(Math.min(msgData.bigBlockSize - bigBlockOffset, blockSize), CONST.MSG.SMALL_BLOCK_SIZE);\n          return ds.readUint8Array(toReadLength);\n        }\n      }\n    },\n    bat: {\n      'extractor': function extractDataViaBat(ds, msgData, fieldProperty, dataTypeExtractor) {\n        var offset = getBlockOffsetAt(msgData, fieldProperty.startBlock);\n        ds.seek(offset);\n        return dataTypeExtractor(ds, fieldProperty);\n      },\n      dataType: {\n        'string': function extractSbatString(ds, fieldProperty) {\n          return ds.readString(fieldProperty.sizeBlock);\n        },\n        'unicode': function extractSbatUnicode(ds, fieldProperty) {\n          return ds.readUCS2String(fieldProperty.sizeBlock / 2);\n        },\n        'binary': function extractSbatBinary(ds, fieldProperty) {\n          return ds.readUint8Array(fieldProperty.sizeBlock);\n        }\n      }\n    }\n  };\n\n  function readDataByBlockSmall(ds, msgData, startBlock, blockSize, dataTypeExtractor) {\n    var byteOffset = startBlock * CONST.MSG.SMALL_BLOCK_SIZE;\n    var bigBlockNumber = Math.floor(byteOffset / msgData.bigBlockSize);\n    var bigBlockOffset = byteOffset % msgData.bigBlockSize;\n    var rootProp = msgData.propertyData[0];\n    var nextBlock = rootProp.startBlock;\n\n    for (var i = 0; i < bigBlockNumber; i++) {\n      nextBlock = getNextBlock(ds, msgData, nextBlock);\n    }\n\n    var blockStartOffset = getBlockOffsetAt(msgData, nextBlock);\n    return dataTypeExtractor(ds, msgData, blockStartOffset, bigBlockOffset, blockSize);\n  }\n\n  function readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor) {\n    var resultData = new Int8Array(fieldProperty.sizeBlock);\n\n    for (var i = 0, idx = 0; i < chain.length; i++) {\n      var data = readDataByBlockSmall(ds, msgData, chain[i], CONST.MSG.SMALL_BLOCK_SIZE, extractorFieldValue.sbat.dataType.binary);\n\n      for (var j = 0; j < data.length; j++) {\n        resultData[idx++] = data[j];\n      }\n    }\n\n    var localDs = new DataStream(resultData, 0, DataStream.LITTLE_ENDIAN);\n    return dataTypeExtractor(localDs, msgData, 0, 0, fieldProperty.sizeBlock);\n  }\n\n  function getChainByBlockSmall(ds, msgData, fieldProperty) {\n    var blockChain = [];\n    var nextBlockSmall = fieldProperty.startBlock;\n\n    while (nextBlockSmall != CONST.MSG.END_OF_CHAIN) {\n      blockChain.push(nextBlockSmall);\n      nextBlockSmall = getNextBlockSmall(ds, msgData, nextBlockSmall);\n    }\n\n    return blockChain;\n  }\n\n  function getFieldValue(ds, msgData, fieldProperty, type) {\n    var value = null;\n    var valueExtractor = fieldProperty.sizeBlock < CONST.MSG.BIG_BLOCK_MIN_DOC_SIZE ? extractorFieldValue.sbat : extractorFieldValue.bat;\n    var dataTypeExtractor = valueExtractor.dataType[CONST.MSG.FIELD.TYPE_MAPPING[type]];\n\n    if (dataTypeExtractor) {\n      value = valueExtractor.extractor(ds, msgData, fieldProperty, dataTypeExtractor);\n    }\n\n    return value;\n  } // MSG Reader\n\n\n  var MSGReader = function (arrayBuffer) {\n    this.ds = new DataStream(arrayBuffer, 0, DataStream.LITTLE_ENDIAN);\n  };\n\n  MSGReader.prototype = {\n    /**\n     Converts bytes to fields information\n      @return {Object} The fields data for MSG file\n     */\n    getFileData: function () {\n      if (!isMSGFile(this.ds)) {\n        return {\n          error: 'Unsupported file type!'\n        };\n      }\n\n      if (this.fileData == null) {\n        this.fileData = parseMsgData(this.ds);\n      }\n\n      return this.fileData.fieldsData;\n    },\n\n    /**\n     Reads an attachment content by key/ID\n      @return {Object} The attachment for specific attachment key\n     */\n    getAttachment: function (attach) {\n      var attachData = typeof attach === 'number' ? this.fileData.fieldsData.attachments[attach] : attach;\n      var fieldProperty = this.fileData.propertyData[attachData.dataId];\n      var fieldData = getFieldValue(this.ds, this.fileData, fieldProperty, getFieldType(fieldProperty));\n      return {\n        fileName: attachData.fileName,\n        content: fieldData\n      };\n    }\n  };\n  return MSGReader;\n});","map":{"version":3,"names":["root","factory","define","amd","exports","module","require","MSGReader","DataStream","CONST","FILE_HEADER","uInt2int","MSG","UNUSED_BLOCK","END_OF_CHAIN","S_BIG_BLOCK_SIZE","S_BIG_BLOCK_MARK","L_BIG_BLOCK_SIZE","L_BIG_BLOCK_MARK","SMALL_BLOCK_SIZE","BIG_BLOCK_MIN_DOC_SIZE","HEADER","PROPERTY_START_OFFSET","BAT_START_OFFSET","BAT_COUNT_OFFSET","SBAT_START_OFFSET","SBAT_COUNT_OFFSET","XBAT_START_OFFSET","XBAT_COUNT_OFFSET","PROP","NO_INDEX","PROPERTY_SIZE","NAME_SIZE_OFFSET","MAX_NAME_LENGTH","TYPE_OFFSET","PREVIOUS_PROPERTY_OFFSET","NEXT_PROPERTY_OFFSET","CHILD_PROPERTY_OFFSET","START_BLOCK_OFFSET","SIZE_OFFSET","TYPE_ENUM","DIRECTORY","DOCUMENT","ROOT","FIELD","PREFIX","ATTACHMENT","RECIPIENT","NAME_MAPPING","CLASS_MAPPING","ATTACHMENT_DATA","TYPE_MAPPING","DIR_TYPE","INNER_MSG","arraysEqual","a","b","length","i","data","result","Array","isMSGFile","ds","seek","readInt8Array","getBlockOffsetAt","msgData","offset","bigBlockSize","getBlockAt","startOffset","readInt32Array","bigBlockLength","getNextBlockInner","blockOffsetData","currentBlock","Math","floor","currentBlockIndex","startBlockOffset","getNextBlock","batData","getNextBlockSmall","sbatData","parseMsgData","headerData","xbatCount","xbatData","propertyData","fieldsData","readByte","xBlockLength","batCount","readInt","propertyStart","sbatStart","sbatCount","xbatStart","batCountInHeader","maxBatsInHeader","min","readInt32","startIndex","push","batCountTotal","remainingBlocks","nextBlockAt","xBatBlock","blocksToProcess","j","blockStartAt","props","currentOffset","convertBlockToProperties","createPropertyHierarchy","convertName","nameLength","readShort","readStringAt","convertProperty","index","type","name","previousProperty","nextProperty","childProperty","startBlock","sizeBlock","propertyBlockOffset","propertyCount","propertyOffset","propertyType","nodeProperty","children","currentIndex","shift","current","fields","attachments","recipients","fieldsDataDir","dirProperty","fieldsDataDirInner","indexOf","fieldsDataDocument","attachmentField","recipientField","childFieldType","getFieldType","innerMsgContent","documentProperty","value","substring","toLowerCase","fieldClass","fieldType","fieldName","getFieldValue","fieldProperty","extractorFieldValue","sbat","extractDataViaSbat","dataTypeExtractor","chain","getChainByBlockSmall","readDataByBlockSmall","readChainDataByBlockSmall","dataType","extractBatString","blockStartOffset","bigBlockOffset","blockSize","readString","extractBatUnicode","readUCS2String","extractBatBinary","toReadLength","readUint8Array","bat","extractDataViaBat","extractSbatString","extractSbatUnicode","extractSbatBinary","byteOffset","bigBlockNumber","rootProp","nextBlock","resultData","Int8Array","idx","binary","localDs","LITTLE_ENDIAN","blockChain","nextBlockSmall","valueExtractor","extractor","arrayBuffer","prototype","getFileData","error","fileData","getAttachment","attach","attachData","dataId","fieldData","fileName","content"],"sources":["/home/bibhu/EDRdevelopment/DevBranch/ReactCodes/node_modules/wl-msg-reader/lib/msg.reader.js"],"sourcesContent":["/* Copyright 2016 Yury Karpovich\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/*\n MSG Reader\n */\n\n(function (root, factory) {\n    if (typeof define === 'function' && define.amd) {\n        // AMD\n        define(['./DataStream'], factory);\n    } else if (typeof exports === 'object') {\n        // Node, CommonJS-like\n        module.exports = factory(require('./DataStream'));\n    } else {\n        // Browser globals (root is window)\n        root.MSGReader = factory(root.DataStream);\n    }\n}(this, function (DataStream) {\n\n  // constants\n  var CONST = {\n    FILE_HEADER: uInt2int([0xD0, 0xCF, 0x11, 0xE0, 0xA1, 0xB1, 0x1A, 0xE1]),\n    MSG: {\n      UNUSED_BLOCK: -1,\n      END_OF_CHAIN: -2,\n\n      S_BIG_BLOCK_SIZE: 0x0200,\n      S_BIG_BLOCK_MARK: 9,\n\n      L_BIG_BLOCK_SIZE: 0x1000,\n      L_BIG_BLOCK_MARK: 12,\n\n      SMALL_BLOCK_SIZE: 0x0040,\n      BIG_BLOCK_MIN_DOC_SIZE: 0x1000,\n      HEADER: {\n        PROPERTY_START_OFFSET: 0x30,\n\n        BAT_START_OFFSET: 0x4c,\n        BAT_COUNT_OFFSET: 0x2C,\n\n        SBAT_START_OFFSET: 0x3C,\n        SBAT_COUNT_OFFSET: 0x40,\n\n        XBAT_START_OFFSET: 0x44,\n        XBAT_COUNT_OFFSET: 0x48\n      },\n      PROP: {\n        NO_INDEX: -1,\n        PROPERTY_SIZE: 0x0080,\n\n        NAME_SIZE_OFFSET: 0x40,\n        MAX_NAME_LENGTH: (/*NAME_SIZE_OFFSET*/0x40 / 2) - 1,\n        TYPE_OFFSET: 0x42,\n        PREVIOUS_PROPERTY_OFFSET: 0x44,\n        NEXT_PROPERTY_OFFSET: 0x48,\n        CHILD_PROPERTY_OFFSET: 0x4C,\n        START_BLOCK_OFFSET: 0x74,\n        SIZE_OFFSET: 0x78,\n        TYPE_ENUM: {\n          DIRECTORY: 1,\n          DOCUMENT: 2,\n          ROOT: 5\n        }\n      },\n      FIELD: {\n        PREFIX: {\n          ATTACHMENT: '__attach_version1.0',\n          RECIPIENT: '__recip_version1.0',\n          DOCUMENT: '__substg1.'\n        },\n        // example (use fields as needed)\n        NAME_MAPPING: {\n          // email specific\n          '0037': 'subject',\n          '0c1a': 'senderName',\n          '5d02': 'senderEmail',\n          '1000': 'body',\n          '007d': 'headers',\n          // attachment specific\n          '3703': 'extension',\n          '3704': 'fileNameShort',\n          '3707': 'fileName',\n          '3712': 'pidContentId',\n          // recipient specific\n          '3001': 'name',\n          '39fe': 'email'\n        },\n        CLASS_MAPPING: {\n          ATTACHMENT_DATA: '3701'\n        },\n        TYPE_MAPPING: {\n          '001e': 'string',\n          '001f': 'unicode',\n          '0102': 'binary'\n        },\n        DIR_TYPE: {\n          INNER_MSG: '000d'\n        }\n      }\n    }\n  };\n\n  // unit utils\n  function arraysEqual(a, b) {\n    if (a === b) return true;\n    if (a == null || b == null) return false;\n    if (a.length != b.length) return false;\n\n    for (var i = 0; i < a.length; i++) {\n      if (a[i] !== b[i]) return false;\n    }\n    return true;\n  }\n\n  function uInt2int(data) {\n    var result = new Array(data.length);\n    for (var i = 0; i < data.length; i++) {\n      result[i] = data[i] << 24 >> 24;\n    }\n    return result;\n  }\n\n  // MSG Reader implementation\n\n  // check MSG file header\n  function isMSGFile(ds) {\n    ds.seek(0);\n    return arraysEqual(CONST.FILE_HEADER, ds.readInt8Array(CONST.FILE_HEADER.length));\n  }\n\n  // FAT utils\n  function getBlockOffsetAt(msgData, offset) {\n    return (offset + 1) * msgData.bigBlockSize;\n  }\n\n  function getBlockAt(ds, msgData, offset) {\n    var startOffset = getBlockOffsetAt(msgData, offset);\n    ds.seek(startOffset);\n    return ds.readInt32Array(msgData.bigBlockLength);\n  }\n\n  function getNextBlockInner(ds, msgData, offset, blockOffsetData) {\n    var currentBlock = Math.floor(offset / msgData.bigBlockLength);\n    var currentBlockIndex = offset % msgData.bigBlockLength;\n\n    var startBlockOffset = blockOffsetData[currentBlock];\n\n    return getBlockAt(ds, msgData, startBlockOffset)[currentBlockIndex];\n  }\n\n  function getNextBlock(ds, msgData, offset) {\n    return getNextBlockInner(ds, msgData, offset, msgData.batData);\n  }\n\n  function getNextBlockSmall(ds, msgData, offset) {\n    return getNextBlockInner(ds, msgData, offset, msgData.sbatData);\n  }\n\n  // convert binary data to dictionary\n  function parseMsgData(ds) {\n    var msgData = headerData(ds);\n    msgData.batData = batData(ds, msgData);\n    msgData.sbatData = sbatData(ds, msgData);\n    if (msgData.xbatCount > 0) {\n      xbatData(ds, msgData);\n    }\n    msgData.propertyData = propertyData(ds, msgData);\n    msgData.fieldsData = fieldsData(ds, msgData);\n\n    return msgData;\n  }\n\n  // extract header data\n  function headerData(ds) {\n    var headerData = {};\n\n    // system data\n    headerData.bigBlockSize =\n      ds.readByte(/*const position*/30) == CONST.MSG.L_BIG_BLOCK_MARK ? CONST.MSG.L_BIG_BLOCK_SIZE : CONST.MSG.S_BIG_BLOCK_SIZE;\n    headerData.bigBlockLength = headerData.bigBlockSize / 4;\n    headerData.xBlockLength = headerData.bigBlockLength - 1;\n\n    // header data\n    headerData.batCount = ds.readInt(CONST.MSG.HEADER.BAT_COUNT_OFFSET);\n    headerData.propertyStart = ds.readInt(CONST.MSG.HEADER.PROPERTY_START_OFFSET);\n    headerData.sbatStart = ds.readInt(CONST.MSG.HEADER.SBAT_START_OFFSET);\n    headerData.sbatCount = ds.readInt(CONST.MSG.HEADER.SBAT_COUNT_OFFSET);\n    headerData.xbatStart = ds.readInt(CONST.MSG.HEADER.XBAT_START_OFFSET);\n    headerData.xbatCount = ds.readInt(CONST.MSG.HEADER.XBAT_COUNT_OFFSET);\n\n    return headerData;\n  }\n\n  function batCountInHeader(msgData) {\n    var maxBatsInHeader = (CONST.MSG.S_BIG_BLOCK_SIZE - CONST.MSG.HEADER.BAT_START_OFFSET) / 4;\n    return Math.min(msgData.batCount, maxBatsInHeader);\n  }\n\n  function batData(ds, msgData) {\n    var result = new Array(batCountInHeader(msgData));\n    ds.seek(CONST.MSG.HEADER.BAT_START_OFFSET);\n    for (var i = 0; i < result.length; i++) {\n      result[i] = ds.readInt32()\n    }\n    return result;\n  }\n\n  function sbatData(ds, msgData) {\n    var result = [];\n    var startIndex = msgData.sbatStart;\n\n    for (var i = 0; i < msgData.sbatCount && startIndex != CONST.MSG.END_OF_CHAIN; i++) {\n      result.push(startIndex);\n      startIndex = getNextBlock(ds, msgData, startIndex);\n    }\n    return result;\n  }\n\n  function xbatData(ds, msgData) {\n    var batCount = batCountInHeader(msgData);\n    var batCountTotal = msgData.batCount;\n    var remainingBlocks = batCountTotal - batCount;\n\n    var nextBlockAt = msgData.xbatStart;\n    for (var i = 0; i < msgData.xbatCount; i++) {\n      var xBatBlock = getBlockAt(ds, msgData, nextBlockAt);\n      nextBlockAt = xBatBlock[msgData.xBlockLength];\n\n      var blocksToProcess = Math.min(remainingBlocks, msgData.xBlockLength);\n      for (var j = 0; j < blocksToProcess; j++) {\n        var blockStartAt = xBatBlock[j];\n        if (blockStartAt == CONST.MSG.UNUSED_BLOCK || blockStartAt == CONST.MSG.END_OF_CHAIN) {\n          break;\n        }\n        msgData.batData.push(blockStartAt);\n      }\n      remainingBlocks -= blocksToProcess;\n    }\n  }\n\n  // extract property data and property hierarchy\n  function propertyData(ds, msgData) {\n    var props = [];\n\n    var currentOffset = msgData.propertyStart;\n\n    while (currentOffset != CONST.MSG.END_OF_CHAIN) {\n      convertBlockToProperties(ds, msgData, currentOffset, props);\n      currentOffset = getNextBlock(ds, msgData, currentOffset);\n    }\n    createPropertyHierarchy(props, /*property with index 0 (zero) always as root*/props[0]);\n    return props;\n  }\n\n  function convertName(ds, offset) {\n    var nameLength = ds.readShort(offset + CONST.MSG.PROP.NAME_SIZE_OFFSET);\n    if (nameLength < 1) {\n      return '';\n    } else {\n      return ds.readStringAt(offset, nameLength / 2);\n    }\n  }\n\n  function convertProperty(ds, index, offset) {\n    return {\n      index: index,\n      type: ds.readByte(offset + CONST.MSG.PROP.TYPE_OFFSET),\n      name: convertName(ds, offset),\n      // hierarchy\n      previousProperty: ds.readInt(offset + CONST.MSG.PROP.PREVIOUS_PROPERTY_OFFSET),\n      nextProperty: ds.readInt(offset + CONST.MSG.PROP.NEXT_PROPERTY_OFFSET),\n      childProperty: ds.readInt(offset + CONST.MSG.PROP.CHILD_PROPERTY_OFFSET),\n      // data offset\n      startBlock: ds.readInt(offset + CONST.MSG.PROP.START_BLOCK_OFFSET),\n      sizeBlock: ds.readInt(offset + CONST.MSG.PROP.SIZE_OFFSET)\n    };\n  }\n\n  function convertBlockToProperties(ds, msgData, propertyBlockOffset, props) {\n\n    var propertyCount = msgData.bigBlockSize / CONST.MSG.PROP.PROPERTY_SIZE;\n    var propertyOffset = getBlockOffsetAt(msgData, propertyBlockOffset);\n\n    for (var i = 0; i < propertyCount; i++) {\n      var propertyType = ds.readByte(propertyOffset + CONST.MSG.PROP.TYPE_OFFSET);\n      switch (propertyType) {\n        case CONST.MSG.PROP.TYPE_ENUM.ROOT:\n        case CONST.MSG.PROP.TYPE_ENUM.DIRECTORY:\n        case CONST.MSG.PROP.TYPE_ENUM.DOCUMENT:\n          props.push(convertProperty(ds, props.length, propertyOffset));\n          break;\n        default:\n          /* unknown property types */\n          props.push(null);\n      }\n\n      propertyOffset += CONST.MSG.PROP.PROPERTY_SIZE;\n    }\n  }\n\n  function createPropertyHierarchy(props, nodeProperty) {\n\n    if (nodeProperty.childProperty == CONST.MSG.PROP.NO_INDEX) {\n      return;\n    }\n    nodeProperty.children = [];\n\n    var children = [nodeProperty.childProperty];\n    while (children.length != 0) {\n      var currentIndex = children.shift();\n      var current = props[currentIndex];\n      if (current == null) {\n        continue;\n      }\n      nodeProperty.children.push(currentIndex);\n\n      if (current.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {\n        createPropertyHierarchy(props, current);\n      }\n      if (current.previousProperty != CONST.MSG.PROP.NO_INDEX) {\n        children.push(current.previousProperty);\n      }\n      if (current.nextProperty != CONST.MSG.PROP.NO_INDEX) {\n        children.push(current.nextProperty);\n      }\n    }\n  }\n\n  // extract real fields\n  function fieldsData(ds, msgData) {\n    var fields = {\n      attachments: [],\n      recipients: []\n    };\n    fieldsDataDir(ds, msgData, msgData.propertyData[0], fields);\n    return fields;\n  }\n\n  function fieldsDataDir(ds, msgData, dirProperty, fields) {\n\n    if (dirProperty.children && dirProperty.children.length > 0) {\n      for (var i = 0; i < dirProperty.children.length; i++) {\n        var childProperty = msgData.propertyData[dirProperty.children[i]];\n\n        if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {\n          fieldsDataDirInner(ds, msgData, childProperty, fields)\n        } else if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DOCUMENT\n          && childProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.DOCUMENT) == 0) {\n          fieldsDataDocument(ds, msgData, childProperty, fields);\n        }\n      }\n    }\n  }\n\n  function fieldsDataDirInner(ds, msgData, dirProperty, fields) {\n    if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.ATTACHMENT) == 0) {\n\n      // attachment\n      var attachmentField = {};\n      fields.attachments.push(attachmentField);\n      fieldsDataDir(ds, msgData, dirProperty, attachmentField);\n    } else if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.RECIPIENT) == 0) {\n\n      // recipient\n      var recipientField = {};\n      fields.recipients.push(recipientField);\n      fieldsDataDir(ds, msgData, dirProperty, recipientField);\n    } else {\n\n      // other dir\n      var childFieldType = getFieldType(dirProperty);\n      if (childFieldType != CONST.MSG.FIELD.DIR_TYPE.INNER_MSG) {\n        fieldsDataDir(ds, msgData, dirProperty, fields);\n      } else {\n        // MSG as attachment currently isn't supported\n        fields.innerMsgContent = true;\n      }\n    }\n  }\n\n  function fieldsDataDocument(ds, msgData, documentProperty, fields) {\n    var value = documentProperty.name.substring(12).toLowerCase();\n    var fieldClass = value.substring(0, 4);\n    var fieldType = value.substring(4, 8);\n\n    var fieldName = CONST.MSG.FIELD.NAME_MAPPING[fieldClass];\n\n    if (fieldName) {\n      fields[fieldName] = getFieldValue(ds, msgData, documentProperty, fieldType);\n    }\n    if (fieldClass == CONST.MSG.FIELD.CLASS_MAPPING.ATTACHMENT_DATA) {\n\n      // attachment specific info\n      fields['dataId'] = documentProperty.index;\n      fields['contentLength'] = documentProperty.sizeBlock;\n    }\n  }\n\n  function getFieldType(fieldProperty) {\n    var value = fieldProperty.name.substring(12).toLowerCase();\n    return value.substring(4, 8);\n  }\n\n  // extractor structure to manage bat/sbat block types and different data types\n  var extractorFieldValue = {\n    sbat: {\n      'extractor': function extractDataViaSbat(ds, msgData, fieldProperty, dataTypeExtractor) {\n        var chain = getChainByBlockSmall(ds, msgData, fieldProperty);\n        if (chain.length == 1) {\n          return readDataByBlockSmall(ds, msgData, fieldProperty.startBlock, fieldProperty.sizeBlock, dataTypeExtractor);\n        } else if (chain.length > 1) {\n          return readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor);\n        }\n        return null;\n      },\n      dataType: {\n        'string': function extractBatString(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          return ds.readString(blockSize);\n        },\n        'unicode': function extractBatUnicode(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          return ds.readUCS2String(blockSize / 2);\n        },\n        'binary': function extractBatBinary(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {\n          ds.seek(blockStartOffset + bigBlockOffset);\n          var toReadLength = Math.min(Math.min(msgData.bigBlockSize - bigBlockOffset, blockSize), CONST.MSG.SMALL_BLOCK_SIZE);\n          return ds.readUint8Array(toReadLength);\n        }\n      }\n    },\n    bat: {\n      'extractor': function extractDataViaBat(ds, msgData, fieldProperty, dataTypeExtractor) {\n        var offset = getBlockOffsetAt(msgData, fieldProperty.startBlock);\n        ds.seek(offset);\n        return dataTypeExtractor(ds, fieldProperty);\n      },\n      dataType: {\n        'string': function extractSbatString(ds, fieldProperty) {\n          return ds.readString(fieldProperty.sizeBlock);\n        },\n        'unicode': function extractSbatUnicode(ds, fieldProperty) {\n          return ds.readUCS2String(fieldProperty.sizeBlock / 2);\n        },\n        'binary': function extractSbatBinary(ds, fieldProperty) {\n          return ds.readUint8Array(fieldProperty.sizeBlock);\n        }\n      }\n    }\n  };\n\n  function readDataByBlockSmall(ds, msgData, startBlock, blockSize, dataTypeExtractor) {\n    var byteOffset = startBlock * CONST.MSG.SMALL_BLOCK_SIZE;\n    var bigBlockNumber = Math.floor(byteOffset / msgData.bigBlockSize);\n    var bigBlockOffset = byteOffset % msgData.bigBlockSize;\n\n    var rootProp = msgData.propertyData[0];\n\n    var nextBlock = rootProp.startBlock;\n    for (var i = 0; i < bigBlockNumber; i++) {\n      nextBlock = getNextBlock(ds, msgData, nextBlock);\n    }\n    var blockStartOffset = getBlockOffsetAt(msgData, nextBlock);\n\n    return dataTypeExtractor(ds, msgData, blockStartOffset, bigBlockOffset, blockSize);\n  }\n\n  function readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor) {\n    var resultData = new Int8Array(fieldProperty.sizeBlock);\n\n    for (var i = 0, idx = 0; i < chain.length; i++) {\n      var data = readDataByBlockSmall(ds, msgData, chain[i], CONST.MSG.SMALL_BLOCK_SIZE, extractorFieldValue.sbat.dataType.binary);\n      for (var j = 0; j < data.length; j++) {\n        resultData[idx++] = data[j];\n      }\n    }\n    var localDs = new DataStream(resultData, 0, DataStream.LITTLE_ENDIAN);\n    return dataTypeExtractor(localDs, msgData, 0, 0, fieldProperty.sizeBlock);\n  }\n\n  function getChainByBlockSmall(ds, msgData, fieldProperty) {\n    var blockChain = [];\n    var nextBlockSmall = fieldProperty.startBlock;\n    while (nextBlockSmall != CONST.MSG.END_OF_CHAIN) {\n      blockChain.push(nextBlockSmall);\n      nextBlockSmall = getNextBlockSmall(ds, msgData, nextBlockSmall);\n    }\n    return blockChain;\n  }\n\n  function getFieldValue(ds, msgData, fieldProperty, type) {\n    var value = null;\n\n    var valueExtractor =\n      fieldProperty.sizeBlock < CONST.MSG.BIG_BLOCK_MIN_DOC_SIZE ? extractorFieldValue.sbat : extractorFieldValue.bat;\n    var dataTypeExtractor = valueExtractor.dataType[CONST.MSG.FIELD.TYPE_MAPPING[type]];\n\n    if (dataTypeExtractor) {\n      value = valueExtractor.extractor(ds, msgData, fieldProperty, dataTypeExtractor);\n    }\n    return value;\n  }\n\n  // MSG Reader\n  var MSGReader = function (arrayBuffer) {\n    this.ds = new DataStream(arrayBuffer, 0, DataStream.LITTLE_ENDIAN);\n  };\n\n  MSGReader.prototype = {\n    /**\n     Converts bytes to fields information\n\n     @return {Object} The fields data for MSG file\n     */\n    getFileData: function () {\n      if (!isMSGFile(this.ds)) {\n        return {error: 'Unsupported file type!'};\n      }\n      if (this.fileData == null) {\n        this.fileData = parseMsgData(this.ds);\n      }\n      return this.fileData.fieldsData;\n    },\n    /**\n     Reads an attachment content by key/ID\n\n     @return {Object} The attachment for specific attachment key\n     */\n    getAttachment: function (attach) {\n      var attachData = typeof attach === 'number' ? this.fileData.fieldsData.attachments[attach] : attach;\n      var fieldProperty = this.fileData.propertyData[attachData.dataId];\n      var fieldData = getFieldValue(this.ds, this.fileData, fieldProperty, getFieldType(fieldProperty));\n\n      return {fileName: attachData.fileName, content: fieldData};\n    }\n  };\n\n  return MSGReader;\n\n}));"],"mappings":"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"},"metadata":{},"sourceType":"script"}